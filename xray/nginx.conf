# 别忘记修改路径
location /XXXX {
    # 限制只有 GET 请求可以访问
    if ($request_method !~ ^(GET)$) {
        return 405;
    }

    # 禁用代理重定向
    proxy_redirect off;

    # 禁用请求缓冲
    proxy_buffering off;
    proxy_request_buffering off;

    # 转发至后端 Xray
    proxy_pass https://127.0.0.1:4431; # Xray 端口（保留你原来使用 TLS 的写法）

    # 确保使用 HTTP/1.1 协议以支持 WebSocket
    proxy_http_version 1.1;

    # 伪装头增加哈希表时空间
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;

    # ---- 浏览器常规头伪装 ----
    # 模拟 iPhone Safari
    proxy_set_header User-Agent         "Mozilla/5.0 (iPhone; CPU iPhone OS 17_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1";
    proxy_set_header Referer            "https://www.icloud.com/";
    proxy_set_header Origin             "https://www.icloud.com";
    proxy_set_header Accept             "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8";
    proxy_set_header Accept-Language    "zh-CN,zh;q=0.9,en;q=0.8";
    proxy_set_header Accept-Encoding    "";
    proxy_set_header Cache-Control      "no-store";
    proxy_set_header Pragma             "no-cache";
    proxy_set_header Upgrade-Insecure-Requests "1";
    proxy_set_header TE                 "Trailers";
    proxy_set_header DNT                "1";

    # ---- Fetch & Client-Hints 头 ----
    proxy_set_header Sec-Fetch-Dest                 "document";
    proxy_set_header Sec-Fetch-Mode                 "navigate";
    proxy_set_header Sec-Fetch-Site                 "none";
    proxy_set_header Sec-Fetch-User                 "?1";
    proxy_set_header Sec-Ch-Ua-Arch                 "x86";
    proxy_set_header Sec-Ch-Ua-Bitness              "64";
    proxy_set_header Sec-Ch-Ua-Form-Factors         "";
    proxy_set_header Sec-Ch-Ua-Full-Version         "17.0.0";
    proxy_set_header Sec-Ch-Ua                      "\"Safari\";v=\"17\", \"Not.A/Brand\";v=\"99\"";
    proxy_set_header Sec-Ch-Ua-Full-Version-List    "\"Safari\";v=\"17.0.0\", \"Not.A/Brand\";v=\"99.0.0.0\"";
    proxy_set_header Sec-Ch-Ua-Mobile               "?0";
    proxy_set_header Sec-Ch-Ua-Platform             "macOS";
    proxy_set_header Sec-Ch-Ua-Platform-Version     "14.6";

    # ---- 自定义伪造 IP / 安全头 ----
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Frame-Options    "DENY";
    proxy_set_header priority           "u=0, i";

    # 保持 WebSocket 连接
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 配置超时
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
    proxy_connect_timeout 30s;

    # 隐藏一些敏感头部
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    # 转发原始 Host 和协议
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 可选：提高日志的详细程度以便于调试
    #access_log /var/log/nginx/iclouddrive_access.log main;
    #error_log /var/log/nginx/iclouddrive_error.log warn;

    # 可选：增加连接数限制来防止过载
    #limit_conn addr 100;
    #limit_req zone=req_limit_per_ip burst=10 nodelay;

    # 可选：增加缓存策略（如果适用）
    #proxy_cache my_cache;
    #proxy_cache_valid 200 1h;
    #proxy_cache_use_stale error timeout updating;
}
